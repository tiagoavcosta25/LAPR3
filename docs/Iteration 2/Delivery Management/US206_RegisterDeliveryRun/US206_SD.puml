@startuml
autonumber
hide footbox

actor "Manager" as U

participant "RegisterDeliveryRunUI" as UI
participant "RegisterDeliveryRunController" as CTRL
participant "ApplicationPOT" as _APP
participant "app\n:ApplicationPOT" as APP
participant "session\n:UserSession" as SESSION

participant "PharmacyDB" as PDB
participant "OrderDB" as ODB
participant "DeliveryRunDB" as DB
participant "delivery\n:Delivery" as D
participant "deliveryRun\n:DeliveryRun" as DR
participant "status\n:DeliveryStatus" as DS


participant "DataHandler" as DH

activate U

U -> UI : Initiates the registration of a delivery run
activate UI

UI -> CTRL : lstOrders = getOrders()
activate CTRL
CTRL -> _APP: app = getInstance()
activate _APP
deactivate _APP

CTRL -> APP : session = getCurrentSession()
activate APP
deactivate APP

CTRL -> SESSION: email = getCurrentUserEmail()
activate SESSION
deactivate SESSION



CTRL -> PDB : getPharmacyByManagerEmail(email)
activate PDB
ref over PDB
SD_CONNECTIONS
end ref
deactivate PDB



CTRL -> ODB : lstOrders = getOrdersFromPharmacy(pharmacy)
activate ODB

ref over ODB
SD_CONNECTIONS
end ref
deactivate ODB
deactivate CTRL


loop until there are no more valid orders to choose\nfrom
UI --> U: Shows the list of orders

deactivate UI




U -> UI : Chooses an order
activate UI
UI -> CTRL : addNewDelivery(order)
activate CTRL
CTRL -> DB : newDelivery(order)
activate DB
DB -> D** : create(order)
deactivate DB

UI --> U : Checks if the manager wants to choose\nanother order
deactivate CTRL
deactivate UI
end


U -> UI : Confirms that there are no more orders\nthat he wants to add

activate UI

UI -> CTRL : newDeliveryRun()

activate CTRL

CTRL -> DB : courier = getSuitableCourier()
activate DB

deactivate DB
ref over DB
SD_CONNECTIONS
end ref
CTRL -> DR** : create(courier,lstDelivery)
activate DR

DR -> DS** : create()

deactivate DR
CTRL -> DB : addNewDeliveryRun(deliveryRun)
activate DB
ref over DB
SD_CONNECTIONS
end ref
deactivate DB
CTRL -> DB : addDelivery(lstDelivery)

activate DB
ref over DB
SD_CONNECTIONS
end ref
deactivate DB

deactivate CTRL

UI --> U : Registers the delivery run and informs\nabout the success of the operation
deactivate UI



deactivate U


@enduml